<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Haskell4py</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Haskell4py</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="applicatives" class="level1">
<h1>Applicatives</h1>
<p>Every Applicative is also a functor. The definition is</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell code-with-copy"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> <span class="dt">Functor</span> context <span class="ot">=&gt;</span> <span class="dt">Applicative</span> context <span class="kw">where</span> </span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ot">    pure ::</span> a <span class="ot">-&gt;</span> context a</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="ot">    (&lt;*&gt;) ::</span> context (a <span class="ot">-&gt;</span> b) <span class="ot">-&gt;</span> context a <span class="ot">-&gt;</span> context b</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This extends <code>Functor</code>, so we already have <code>fmap/&lt;$&gt;</code> defined for this context as well.</p>
<p>This is something I had a lot of trouble getting used to, so let’s start with a motivating example.</p>
<section id="motivational-examples" class="level2">
<h2 class="anchored" data-anchor-id="motivational-examples">Motivational examples</h2>
<section id="currency-converter" class="level3">
<h3 class="anchored" data-anchor-id="currency-converter">Currency converter</h3>
<p>The problem we are going to solve is building a currency converter.</p>
<p>What we would <em>like</em> is to be enter a currency in one denomination, and get the value in another denomination, like so</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell code-with-copy"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> convertCurrency (<span class="dt">Currency</span> <span class="st">"YEN"</span> <span class="dv">10000</span>) <span class="st">"NZD"</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="dt">Just</span> <span class="dt">Currency</span> <span class="st">"NZD"</span> <span class="fl">109.60</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Here we return a <code>Maybe</code> datatype, in case the user gives us a currency that does not exist, or that we have not tracked.</p>
<p>Let’s start by assuming that all currency transactions are transitive, and then getting some currency exchange rates against the USD.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell code-with-copy"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Map</span> <span class="kw">as</span> <span class="dt">M</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Currency</span> <span class="ot">=</span> <span class="dt">Currency</span> <span class="dt">String</span> <span class="dt">Float</span> <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="ot">oneUSDTo ::</span> <span class="dt">M.Map</span> <span class="dt">String</span> <span class="dt">Float</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>oneUSDTo <span class="ot">=</span> M.fromList [</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"USD"</span>, <span class="fl">1.00</span>), (<span class="st">"YEN"</span>, <span class="fl">156.02</span>), (<span class="st">"RMB"</span>, <span class="fl">7.03</span>), </span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"EUR"</span>, <span class="fl">0.850</span>), (<span class="st">"WON"</span>, <span class="fl">1444.45</span>), (<span class="st">"NZD"</span>, <span class="fl">1.71</span>),</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"AUD"</span>, <span class="fl">1.49</span>), (<span class="st">"GBP"</span>, <span class="fl">0.74</span>)]</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="ot">convert ::</span> <span class="dt">Float</span> <span class="ot">-&gt;</span> <span class="dt">Float</span> <span class="ot">-&gt;</span> <span class="dt">Float</span> <span class="ot">-&gt;</span> <span class="dt">Float</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>convert rateSrc rateDest valSrc <span class="ot">=</span> valInUSD <span class="op">*</span> rateDest</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span> valInUSD <span class="ot">=</span> valSrc <span class="op">/</span> rateSrc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Doing a manual lookup, 1 USD = 156.02 Yen = 1.71 NZD, so our convert function to answer the question “how many NZD is 10k YEN” would be</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell code-with-copy"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="op">:</span>l converter01</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> convert <span class="fl">156.02</span> <span class="fl">1.71</span> <span class="dv">10000</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fl">109.60</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We want to move from a function where you use the rates explicitly, to one where we use our lookup table.</p>
<p>Here is one way to do it that works</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell code-with-copy"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ot">convertCurrency ::</span> <span class="dt">Currency</span> <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Currency</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>convertCurrency (<span class="dt">Currency</span> nameSrc value) nameDest <span class="ot">=</span> <span class="kw">case</span> M.lookup nameSrc oneUSDTo <span class="kw">of</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="dt">Nothing</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Just</span> rateSrc <span class="ot">-&gt;</span> <span class="kw">case</span> M.lookup nameDest oneUSDTo <span class="kw">of</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="dt">Nothing</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Just</span> rateDest <span class="ot">-&gt;</span> <span class="dt">Just</span> (<span class="dt">Currency</span> nameDest (convert rateSrc rateDest value))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>But this obscutes the actual logic of what we want. Let’s write something that is <em>not</em> valid, but gets the idea of what we want</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell code-with-copy"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Note this doesn't work</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="ot">convertCurrency ::</span> <span class="dt">Currency</span> <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Currency</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>convertCurreny (<span class="dt">Currency</span> nameSrc value) nameDest <span class="ot">=</span> <span class="dt">Currency</span> nameDest (convert' rateSrc rateDest value)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span><span class="ot"> rateSrc ::</span> <span class="dt">Maybe</span> <span class="dt">Float</span> <span class="ot">=</span> M.lookup nameSrc oneUSDTo</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="ot">        rateDest ::</span> <span class="dt">Maybe</span> <span class="dt">Float</span> <span class="ot">=</span> M.lookup nameDest oneUSDTo</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="ot">        convert' ::</span> <span class="dt">Maybe</span> <span class="dt">Float</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Float</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Float</span> </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        convert' msrc mdest value <span class="ot">=</span> <span class="op">.....</span> <span class="op">-</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>There are two problems here:</p>
<ol type="1">
<li>The returned type is a <code>Currency</code>, not a <code>Maybe Currency</code>. We need to do the work to see if the <code>convert'</code> function fails.</li>
<li>If there were no <code>Maybe</code> functors around, we would be able to write <code>convert'</code> pretty simply as <code>convert' rateSrc rateDest value = convert rateSrc rateDest value</code>. But the <code>rateSrc</code> and <code>rateDest</code> living inside a <code>Maybe</code> stops us from doing this.</li>
</ol>
<p>When we had a function with only one argument, then <code>fmap</code> allowed us to push the function inside the container. An applicative will allow us to do this for functions with “multiple arguments” (technically all Haskell functions have one argument, but we often think of a function as taking multiple arguments).</p>
</section>
<section id="binary-functions-why-fmap-isnt-enough" class="level3">
<h3 class="anchored" data-anchor-id="binary-functions-why-fmap-isnt-enough">Binary functions: why <code>fmap</code> isn’t enough</h3>
<p>Let’s start with a simpler example, with the binary function addition. We know the function</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell code-with-copy"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>(<span class="op">+</span><span class="dv">3</span>)<span class="ot"> ::</span> <span class="dt">Num</span> a <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> a</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>is a function that takes a number to another number. If we wanted to operate on a <code>Maybe Int</code>, we can push the function into the <code>Maybe</code> as follows:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell code-with-copy"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="fu">fmap</span> (<span class="op">+</span><span class="dv">3</span>) (<span class="dt">Just</span> <span class="dv">5</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="dt">Just</span> <span class="dv">8</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>But this doesn’t work:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell code-with-copy"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span>  <span class="fu">fmap</span> (<span class="op">+</span>) (<span class="dt">Just</span> <span class="dv">3</span>) (<span class="dt">Just</span> <span class="dv">5</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co">-- error</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We would need an <code>fmap2</code> with an argument</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell code-with-copy"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ot">fmap2 ::</span> (a<span class="ot">-&gt;</span>b<span class="ot">-&gt;</span>c) <span class="ot">-&gt;</span> context a <span class="ot">-&gt;</span> context b <span class="ot">-&gt;</span> context c</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If we wrote <code>fmap2</code>, then we would need a separate <code>fmap3</code> for three arguments, and so on.</p>
<p>Instead, Haskell uses two operations that look weird on first glance:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell code-with-copy"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> (<span class="dt">Functor</span> context) <span class="ot">=&gt;</span> <span class="dt">Applicative</span> context <span class="kw">where</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="ot">    pure  ::</span> a <span class="ot">-&gt;</span> context a</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="ot">    (&lt;*&gt;) ::</span> context (a <span class="ot">-&gt;</span> b) <span class="ot">-&gt;</span> context a <span class="ot">-&gt;</span> context b</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Let’s start with why <code>&lt;*&gt;</code> is useful, and compare to <code>fmap</code>:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell code-with-copy"><code class="sourceCode haskell"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ot">  fmap ::</span> (a <span class="ot">-&gt;</span> b) <span class="ot">-&gt;</span> context a <span class="ot">-&gt;</span> context b</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Let’s start by trying to apply <code>fmap</code> to <code>+</code> in the following way:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell code-with-copy"><code class="sourceCode haskell"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>gchi<span class="op">&gt;</span> partial <span class="ot">=</span> <span class="fu">fmap</span> (<span class="op">+</span>) (<span class="dt">Just</span> <span class="dv">2</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>gchi<span class="op">&gt;</span> <span class="op">:</span>i partial</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="ot">partial ::</span> <span class="dt">Num</span> a <span class="ot">=&gt;</span> <span class="dt">Maybe</span> (a <span class="ot">-&gt;</span> a)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>It might be surprising that <code>partial</code> was defined – doesn’t <code>fmap</code> only take functions of a single variable? Yes, but in Haskell all functions are a functions of a single variable! We generally think of addition as a binary operator, taking two numbers to get a number, but recall</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell code-with-copy"><code class="sourceCode haskell"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>(<span class="op">+</span><span class="dv">3</span>)<span class="ot"> ::</span> <span class="dt">Num</span> a <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> a</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Applying one argument (e.g.&nbsp;3) to addition gives you a new function <code>(+3)</code>, which maps a number to the number plus three. In the <code>fmap</code> syntax, using some extra parens:</p>
<pre><code>fmap (+) (Just 2)              =
     (a-&gt;(a-&gt;a)) (Maybe a)     = (Maybe a-&gt;a)</code></pre>
<p>The result of “pushing” <code>(+)</code> into the <code>Maybe</code> is that we now have a function <code>a-&gt;a</code> inside a <code>Maybe</code>. Now we can see how the</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode haskell code-with-copy"><code class="sourceCode haskell"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;*&gt;:</span> <span class="dt">Maybe</span> (a<span class="ot">-&gt;</span>b) <span class="ot">-&gt;</span> <span class="dt">Maybe</span> a <span class="ot">-&gt;</span> <span class="dt">Maybe</span> b</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>can be useful. Very verbosely, we have</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode haskell code-with-copy"><code class="sourceCode haskell"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> (<span class="fu">fmap</span> (<span class="op">+</span>) (<span class="dt">Just</span> <span class="dv">2</span>)) <span class="op">&lt;*&gt;</span> (<span class="dt">Just</span> <span class="dv">5</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="dt">Just</span> <span class="dv">7</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co">-- using the infix operator</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> ( (<span class="op">+</span>) <span class="op">&lt;$&gt;</span> (<span class="dt">Just</span> <span class="dv">2</span>)) <span class="op">&lt;*&gt;</span> (<span class="dt">Just</span> <span class="dv">5</span>)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="dt">Just</span> <span class="dv">7</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> (<span class="op">+</span>) <span class="op">&lt;$&gt;</span> (<span class="dt">Just</span> <span class="dv">2</span>) <span class="op">&lt;*&gt;</span> (<span class="dt">Just</span> <span class="dv">5</span>)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="dt">Just</span> <span class="dv">7</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This gives us a general strategy:</p>
<ol type="1">
<li>The first <code>fmap</code> will place the partially applied function in the context.</li>
<li>We can then use <code>&lt;*&gt;</code> for all the remaining arguments, as we will get back partially applied functions in the context, or the final value in the context.</li>
</ol>
<p>We will refine this strategy in a moment.</p>
</section>
<section id="back-to-the-currency-converter" class="level3">
<h3 class="anchored" data-anchor-id="back-to-the-currency-converter">Back to the currency converter</h3>
<p>Let’s see this at work for our conversion function:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode haskell code-with-copy"><code class="sourceCode haskell"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="op">:</span>l converter01<span class="op">.</span>hs</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="op">:</span>i convert</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="ot">convert ::</span> <span class="dt">Float</span> <span class="ot">-&gt;</span> <span class="dt">Float</span> <span class="ot">-&gt;</span> <span class="dt">Float</span> <span class="ot">-&gt;</span> <span class="dt">Float</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> convert <span class="op">&lt;$&gt;</span> (<span class="dt">Just</span> <span class="fl">1.34</span>) <span class="op">&lt;*&gt;</span> (<span class="dt">Just</span> <span class="fl">0.90</span>) <span class="op">&lt;*&gt;</span> (<span class="dt">Just</span> <span class="dv">10000</span>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="dt">Just</span> <span class="fl">6716.4175</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co">-- Let's step through it</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> p1 <span class="ot">=</span> convert <span class="op">&lt;$&gt;</span> (<span class="dt">Just</span> <span class="fl">1.34</span>)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="op">:</span>i p1</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="dt">Maybe</span> (<span class="dt">Float</span> <span class="ot">-&gt;</span> (<span class="dt">Float</span> <span class="ot">-&gt;</span> <span class="dt">Float</span>))</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> p2 <span class="ot">=</span> p1 <span class="op">&lt;*&gt;</span> (<span class="dt">Just</span> <span class="fl">0.90</span>)</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="op">:</span>i p2</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="ot">p2 ::</span> <span class="dt">Maybe</span> (<span class="dt">Float</span> <span class="ot">-&gt;</span> <span class="dt">Float</span>) </span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> p3 <span class="ot">=</span> p2 <span class="op">&lt;*&gt;</span> (<span class="dt">Just</span> <span class="dv">10000</span>)</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="op">:</span>i p3</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="ot">p3 ::</span> <span class="dt">Maybe</span> <span class="dt">Float</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>There are two things that may seem unsatisfactory: 1. In our actual application, we have <code>Maybe</code> for the rates, as the map lookup might fail. But we have an actual value for the amount we want to convert, not a <code>Maybe</code>. 2. More generally, the first application is treated differently (we apply <code>fmap/&lt;$&gt;</code> to get our function into the context).</p>
<p>The first problem is pretty straightforward: If I have an <code>amount::Float</code> (not a <code>Maybe Float</code>) that I want to convert, I cannot use the <code>&lt;*&gt;</code> pattern directly. But what I can do is use <code>Just amount</code>, which make the amount I had and puts it into the <code>Maybe</code> context.</p>
<p>I can actually do this with the function <code>convert</code> as well! This function has type <code>Float -&gt; Float -&gt; Float -&gt; Float</code>, but <code>Just convert</code> has type <code>Just (Float -&gt; Float -&gt; Float -&gt; Float)</code>. I don’t need to apply <code>fmap</code> to put the function into a context, I can apply <code>Just</code> to it! We can see this by looking at the example above</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode haskell code-with-copy"><code class="sourceCode haskell"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="op">:</span>l converter01<span class="op">.</span>hs</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> convert <span class="op">&lt;$&gt;</span> (<span class="dt">Just</span> <span class="fl">1.34</span>) <span class="op">&lt;*&gt;</span> (<span class="dt">Just</span> <span class="fl">0.90</span>) <span class="op">&lt;*&gt;</span> (<span class="dt">Just</span> <span class="dv">10000</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="dt">Just</span> <span class="fl">6716.4175</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- Note that we now have a chain of &lt;*&gt;</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> (<span class="dt">Just</span> convert) <span class="op">&lt;*&gt;</span> (<span class="dt">Just</span> <span class="fl">1.34</span>) <span class="op">&lt;*&gt;</span> (<span class="dt">Just</span> <span class="fl">0.90</span>) <span class="op">&lt;*&gt;</span> (<span class="dt">Just</span> <span class="dv">10000</span>)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="dt">Just</span> <span class="fl">6716.4175</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This motiviates the other function an applicative gives us: <code>pure</code>. It is a way of taking a “pure” value and putting it inside the applicative’s context. In the case of <code>Maybe</code>, this is using <code>Just</code>. Rewriting again:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode haskell code-with-copy"><code class="sourceCode haskell"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> (<span class="fu">pure</span> convert) <span class="op">&lt;*&gt;</span> (<span class="dt">Just</span> <span class="fl">1.34</span>) <span class="op">&lt;*&gt;</span> (<span class="dt">Just</span> <span class="fl">0.90</span>) <span class="op">&lt;*&gt;</span> (<span class="dt">Just</span> <span class="dv">10000</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="dt">Just</span> <span class="fl">6716.4175</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co">-- Can also do to the 10_000 at the end</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> (<span class="fu">pure</span> convert) <span class="op">&lt;*&gt;</span> (<span class="dt">Just</span> <span class="fl">1.34</span>) <span class="op">&lt;*&gt;</span> (<span class="dt">Just</span> <span class="fl">0.90</span>) <span class="op">&lt;*&gt;</span> (<span class="fu">pure</span> <span class="dv">10000</span>)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="dt">Just</span> <span class="fl">6716.4175</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Using the “lifting” terminology, <code>pure</code> takes a value and “lifts” it into the context.</p>
<p>Let’s give our final version of the currency calculator</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode haskell code-with-copy"><code class="sourceCode haskell"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Map</span> <span class="kw">as</span> <span class="dt">M</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Currency</span> <span class="ot">=</span> <span class="dt">Currency</span> <span class="dt">String</span> <span class="dt">Float</span> <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="ot">oneUSDTo ::</span> <span class="dt">M.Map</span> <span class="dt">String</span> <span class="dt">Float</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>oneUSDTo <span class="ot">=</span> M.fromList [</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"USD"</span>, <span class="fl">1.00</span>), (<span class="st">"YEN"</span>, <span class="fl">156.02</span>), (<span class="st">"RMB"</span>, <span class="fl">7.03</span>), </span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"EUR"</span>, <span class="fl">0.850</span>), (<span class="st">"WON"</span>, <span class="fl">1444.45</span>), (<span class="st">"NZD"</span>, <span class="fl">1.71</span>),</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"AUD"</span>, <span class="fl">1.49</span>), (<span class="st">"GBP"</span>, <span class="fl">0.74</span>)]</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="ot">convert ::</span> <span class="dt">Float</span> <span class="ot">-&gt;</span> <span class="dt">Float</span> <span class="ot">-&gt;</span> <span class="dt">Float</span> <span class="ot">-&gt;</span> <span class="dt">Float</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>convert rateSrc rateDest valSrc <span class="ot">=</span> valInUSD <span class="op">*</span> rateDest</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span> valInUSD <span class="ot">=</span> valSrc <span class="op">/</span> rateSrc</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a><span class="ot">convertCurrency ::</span> <span class="dt">Currency</span> <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Currency</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>convertCurrency (<span class="dt">Currency</span> nameSrc value) nameDest <span class="ot">=</span> <span class="dt">Currency</span> nameDest <span class="op">&lt;$&gt;</span> newValue</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span> rateSrc <span class="ot">=</span> M.lookup nameSrc oneUSDTo</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>        rateDest <span class="ot">=</span> M.lookup nameDest oneUSDTo</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>        newValue <span class="ot">=</span> (<span class="fu">pure</span> convert) <span class="op">&lt;*&gt;</span> rateSrc <span class="op">&lt;*&gt;</span> rateDest <span class="op">&lt;*&gt;</span> (<span class="fu">pure</span> value)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Running a couple of examples:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode haskell code-with-copy"><code class="sourceCode haskell"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="op">:</span>l converter03</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> convertCurrency (<span class="dt">Currency</span> <span class="st">"YEN"</span> <span class="dv">10000</span>) <span class="st">"RMB"</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="dt">Just</span> (<span class="dt">Currency</span> <span class="st">"RMB"</span> <span class="fl">450.58325</span>)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- Giving an example of a currency we don't have the exchange rate of, Bitcoin</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> convertCurrency (<span class="dt">Currency</span> <span class="st">"YEN"</span> <span class="dv">10000</span>) <span class="st">"BTC"</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="dt">Nothing</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="applicatives-and-laws" class="level2">
<h2 class="anchored" data-anchor-id="applicatives-and-laws">Applicatives and laws</h2>
<p>The main motivation for appliciatives are to use what we did with <code>fmap</code> (pushing functions of a single argument into a context) to other functions that take more arguments. The examples used the <code>Maybe</code> context extensively, but let’s generalize this to other contexts.</p>
<p>For a formal defintion, an Applicative <code>context</code> is also a functor (i.e.&nbsp;already has <code>fmap</code>) with two additional functions: * <code>&lt;*&gt; :: context (a-&gt;b) -&gt; context a -&gt; context b</code> * <code>pure :: a -&gt; context a</code></p>
<p>In code, the definition is</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode haskell code-with-copy"><code class="sourceCode haskell"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> <span class="dt">Functor</span> context <span class="ot">=&gt;</span> <span class="dt">Applicative</span> context <span class="kw">where</span> </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="ot">    pure ::</span> a <span class="ot">-&gt;</span> context a</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="ot">    (&lt;*&gt;) ::</span> context (a <span class="ot">-&gt;</span> b) <span class="ot">-&gt;</span> context a <span class="ot">-&gt;</span> context b</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>There are also five applicative laws (not enforced by the compiler, but enforced by convention). From wikipedia:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode haskell code-with-copy"><code class="sourceCode haskell"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span><span class="op">.</span> <span class="fu">pure</span> <span class="fu">id</span> <span class="op">&lt;*&gt;</span> v <span class="ot">=</span> v                            <span class="co">-- Identity</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span><span class="op">.</span> <span class="fu">pure</span> f <span class="op">&lt;*&gt;</span> <span class="fu">pure</span> x <span class="ot">=</span> <span class="fu">pure</span> (f x)               <span class="co">-- Homomorphism</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span><span class="op">.</span> u <span class="op">&lt;*&gt;</span> <span class="fu">pure</span> y <span class="ot">=</span> <span class="fu">pure</span> (<span class="op">$</span> y) <span class="op">&lt;*&gt;</span> u              <span class="co">-- Interchange</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span><span class="op">.</span> <span class="fu">pure</span> (<span class="op">.</span>) <span class="op">&lt;*&gt;</span> u <span class="op">&lt;*&gt;</span> v <span class="op">&lt;*&gt;</span> w <span class="ot">=</span> u <span class="op">&lt;*&gt;</span> (v <span class="op">&lt;*&gt;</span> w) <span class="co">-- Composition</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="dv">5</span><span class="op">.</span> <span class="fu">fmap</span> f x <span class="ot">=</span> (<span class="fu">pure</span> f) <span class="op">&lt;*&gt;</span> x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Let’s start with the last one: the idea of the <code>&lt;*&gt;</code> operator is that it allows us to generalize <code>fmap</code>. We saw two different ways of doing this:</p>
<ul>
<li>Use <code>fmap</code> once, to get the function into the context, and then use <code>&lt;*&gt;</code> on the remaining partial applications</li>
<li>Use <code>(pure f)</code> to put the function into the context, and then use <code>&lt;*&gt;</code> for all the partial applications.</li>
</ul>
<p>Rule 5 guarantees that these two approaches do the same thing.</p>
<p>The other 4 rules capture the idea that <code>pure</code> puts a value in a context, while making as few other changes as possible. In words</p>
<ol type="1">
<li>Make sure that lifting the identity function to a context gives you the identity function between contexts.</li>
<li>(Applying a function and then lifting) is the same as (lifting the function, lifting the value, and then using the lifted function to transform the lifted value)</li>
<li>Composition is associative.</li>
</ol>
<p>To implement the Applicative for <code>Maybe</code> the code is</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode haskell code-with-copy"><code class="sourceCode haskell"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Applicative</span> <span class="dt">Maybe</span> <span class="kw">where</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- pure :: a -&gt; Maybe a</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pure</span> x                <span class="ot">=</span> <span class="dt">Just</span> x</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- &lt;*&gt; :: Maybe (a-&gt;b) -&gt; Maybe a -&gt; Maybe b</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    (<span class="dt">Just</span> f) <span class="op">&lt;*&gt;</span> (<span class="dt">Just</span> x) <span class="ot">=</span> <span class="dt">Just</span> (f x)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    _        <span class="op">&lt;*&gt;</span> _        <span class="ot">=</span> <span class="dt">Nothing</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="style-guide-for-applicatives-lifta2-lifta3-..-liftan" class="level2">
<h2 class="anchored" data-anchor-id="style-guide-for-applicatives-lifta2-lifta3-..-liftan">Style guide for applicatives: <code>liftA2</code>, <code>liftA3</code>, .., <code>liftAN</code></h2>
<p>We have already talked about how, given a binary function <code>binFunc</code> we can lift the function into an applicative context <code>Context</code> in two ways</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode haskell code-with-copy"><code class="sourceCode haskell"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- binFunc :: a -&gt; b -&gt; c</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co">-- argInContext1 :: Context a</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co">-- argInContext2 :: Context b</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>binFunc <span class="op">&lt;$&gt;</span> argInContext1 <span class="op">&lt;*&gt;</span> argInContext2</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="co">--example</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>(<span class="op">+</span>) <span class="op">&lt;$&gt;</span> (<span class="dt">Just</span> <span class="dv">5</span>) <span class="op">&lt;*&gt;</span> (<span class="dt">Just</span> <span class="dv">10</span>)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="co">-- Just 15</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="co">-- OR</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>(<span class="fu">pure</span> binFunc) <span class="op">&lt;*&gt;</span> argInContext1 <span class="op">&lt;*&gt;</span> argInContext2</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="co">-- example</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>(<span class="fu">pure</span> (<span class="op">+</span>)) <span class="op">&lt;*&gt;</span> (<span class="dt">Just</span> <span class="dv">5</span>) <span class="op">&lt;*&gt;</span> (<span class="dt">Just</span> <span class="dv">10</span>)</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="co">-- Just 15</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>There is an alternative, which is to use</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode haskell code-with-copy"><code class="sourceCode haskell"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Control.Applicative</span> (liftA2)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="ot">liftA2 ::</span> (a<span class="ot">-&gt;</span>b<span class="ot">-&gt;</span>c) <span class="ot">-&gt;</span> (<span class="dt">Context</span> a) <span class="ot">-&gt;</span> (<span class="dt">Context</span> b) <span class="ot">-&gt;</span> (<span class="dt">Context</span> c)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>liftA2 binFunc x y <span class="ot">=</span> (<span class="fu">pure</span> binFunc) <span class="op">&lt;*&gt;</span> x <span class="op">&lt;*&gt;</span> y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>That is, <code>liftA2</code> is exactly the function we wanted in the motivation section, except there we called it <code>fmap2</code>.</p>
<p>Similarly, there is a <code>liftA3</code> that does exactly what you would expect:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode haskell code-with-copy"><code class="sourceCode haskell"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>liftA3<span class="op">:</span> (a<span class="ot">-&gt;</span>b<span class="ot">-&gt;</span>c<span class="ot">-&gt;</span>d) <span class="ot">-&gt;</span> <span class="dt">Context</span> a <span class="ot">-&gt;</span> <span class="dt">Context</span> b <span class="ot">-&gt;</span> <span class="dt">Context</span> c <span class="ot">-&gt;</span> <span class="dt">Context</span> d</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>liftA3 triFunc x y z <span class="ot">=</span> (<span class="fu">pure</span> triFunc) <span class="op">&lt;*&gt;</span> x <span class="op">&lt;*&gt;</span> y <span class="op">&lt;*&gt;</span> z</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Stylewise, it is preferred to use <code>liftA2</code> and <code>liftA3</code> over <code>(pure ...) &lt;*&gt; .. &lt;*&gt; ..</code> or <code>(..) &lt;$&gt; .. &lt;*&gt; .. &lt;*&gt; ..</code> because the <code>liftAN</code> functions more clearly signals intent, and that the operators <code>&lt;$&gt;</code> and <code>&lt;*&gt;</code> can be difficult to parse. It starts to look like a regular expression.</p>
</section>
<section id="example-built-in-applicatives" class="level2">
<h2 class="anchored" data-anchor-id="example-built-in-applicatives">Example built-in applicatives</h2>
<ul>
<li>Maybe</li>
<li>Either</li>
<li>IO</li>
</ul>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<ul>
<li>All applicatives are already functors.</li>
<li>The functor <code>fmap</code> allows us to push a function of a single value into a context. The appliciative operator <code>&lt;*&gt;</code> allows us to push a function of multiple arguments into a context.</li>
<li>For example, using <code>Maybe</code>, and the function <code>factorial :: n -&gt; n</code></li>
</ul>
<div class="sourceCode" id="cb29"><pre class="sourceCode haskell code-with-copy"><code class="sourceCode haskell"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="ot">factorial ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>factorial <span class="dv">0</span> <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>factorial n <span class="ot">=</span> n <span class="op">*</span> factorial (n<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="fu">fmap</span> factorial (<span class="dt">Just</span> <span class="dv">3</span>)       <span class="co">--  Just 6</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="fu">fmap</span> factorial (<span class="dt">Nothing</span>)      <span class="co">--   Nothing</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="co">-- allow (+):: Int-&gt; Int-&gt; Int to be pure (+) :: Maybe Int -&gt; Maybe Int -&gt; Maybe Int</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>(<span class="fu">pure</span> (<span class="op">+</span>)) <span class="op">&lt;*&gt;</span> (<span class="dt">Just</span> <span class="dv">3</span>) <span class="op">&lt;*&gt;</span> (<span class="dt">Just</span> <span class="dv">6</span>)   <span class="co">-- Just 9</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>(<span class="fu">pure</span> (<span class="op">+</span>)) <span class="op">&lt;*&gt;</span> (<span class="dt">Just</span> <span class="dv">3</span>) <span class="op">&lt;*&gt;</span> (<span class="dt">Nothing</span>)  <span class="co">-- Nothing</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>(<span class="op">+</span>) <span class="op">&lt;$&gt;</span> (<span class="dt">Just</span> <span class="dv">3</span>) <span class="op">&lt;*&gt;</span> (<span class="dt">Nothing</span>)  <span class="co">-- equivlent to above</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="co">-- Let's define a ternary function</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a><span class="ot">f ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>f a b c <span class="ot">=</span> (a<span class="op">+</span>b)<span class="op">*</span>c</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>(<span class="fu">pure</span> f) <span class="op">&lt;*&gt;</span> (<span class="dt">Just</span> <span class="dv">6</span>) <span class="op">&lt;*&gt;</span> (<span class="dt">Just</span> <span class="dv">7</span>) <span class="op">&lt;*&gt;</span> (<span class="dt">Just</span> <span class="dv">2</span>) <span class="co">-- Just (6+7)*2 = Just 26</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>f <span class="op">&lt;$&gt;</span> (<span class="dt">Just</span> <span class="dv">6</span>) <span class="op">&lt;*&gt;</span> (<span class="dt">Just</span> <span class="dv">7</span>) <span class="op">&lt;*&gt;</span> (<span class="dt">Just</span> <span class="dv">2</span>) <span class="co">-- Just (6+7)*2 = Just 26</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>For functions with 2 or 3 arguments, often <code>liftA2</code> and <code>liftA3</code> from <code>Control.Applicative</code> are used instead, to reduce the line noise from <code>&lt;$&gt;</code> and <code>&lt;*&gt;</code></li>
</ul>
<div class="sourceCode" id="cb30"><pre class="sourceCode haskell code-with-copy"><code class="sourceCode haskell"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- these are all equivalent</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>(<span class="fu">pure</span> (<span class="op">+</span>)) <span class="op">&lt;*&gt;</span> (<span class="dt">Just</span> <span class="dv">3</span>) <span class="op">&lt;*&gt;</span> (<span class="dt">Nothing</span>)  <span class="co">-- Nothing</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>(<span class="op">+</span>) <span class="op">&lt;$&gt;</span> (<span class="dt">Just</span> <span class="dv">3</span>) <span class="op">&lt;*&gt;</span> (<span class="dt">Nothing</span>)         <span class="co">-- Nothing</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>liftA2 (<span class="op">+</span>) (<span class="dt">Just</span> <span class="dv">3</span>) (<span class="dt">Nothing</span>)          <span class="co">-- Nothing</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="co">-- liftA2 f a b = f &lt;$&gt; a &lt;*&gt; b </span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="co">-- these are all equivalent</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>(<span class="fu">pure</span> f) <span class="op">&lt;*&gt;</span> (<span class="dt">Just</span> <span class="dv">6</span>) <span class="op">&lt;*&gt;</span> (<span class="dt">Just</span> <span class="dv">7</span>) <span class="op">&lt;*&gt;</span> (<span class="dt">Just</span> <span class="dv">2</span>) <span class="co">-- Just (6+7)*2 = Just 26</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>f <span class="op">&lt;$&gt;</span> (<span class="dt">Just</span> <span class="dv">6</span>) <span class="op">&lt;*&gt;</span> (<span class="dt">Just</span> <span class="dv">7</span>) <span class="op">&lt;*&gt;</span> (<span class="dt">Just</span> <span class="dv">2</span>)        <span class="co">-- Just (6+7)*2 = Just 26</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>liftA3 f (<span class="dt">Just</span> <span class="dv">6</span>) (<span class="dt">Just</span> <span class="dv">7</span>) (<span class="dt">Just</span> <span class="dv">2</span>)             <span class="co">-- Just (6+7)*2</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="co">-- liftA2 f a b c = f &lt;$&gt; a &lt;*&gt; b  &lt;*&gt; c</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Really useful when chaining lookups from Maps, where the results return <code>Maybe</code>!</li>
<li>To use applicatives, you need to have all the values in the same context. If you have raw values, you can use <code>pure</code> to lift them into the context. We did this in the currency conversion example at the beginning of the chapter.</li>
</ul>
<p>In this chapter we didn’t look at the <code>List</code> type as an applicative, and instead devote the next chapter to that.</p>
<p>To extend a context <code>X</code> to an applicative, use</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode haskell code-with-copy"><code class="sourceCode haskell"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Applicative</span> <span class="dt">X</span> <span class="kw">where</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- pure :: a -&gt; X a</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pure</span> x                <span class="ot">=</span> <span class="op">....</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- &lt;*&gt; :: X (a-&gt;b) -&gt; X a -&gt; X b</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;*&gt;</span>                   <span class="ot">=</span> <span class="op">....</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>